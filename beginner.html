<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beginner Band — Concert Bb Scale (Matched)</title>
  <!-- VexFlow v3 UMD -->
  <script src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    h1 { margin-top: 20px; }
    .controls { display: flex; gap: 16px; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .controls label { user-select: none; }
    .row { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; margin-top: 16px; }
    .label { font-weight: 600; margin: 6px 0 0; }
    .staff { width: 640px; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.2); padding: 10px; }
    button { margin: 16px 6px 24px; padding: 10px 20px; font-size: 18px; border: none; border-radius: 10px; background: #4caf50; color: #fff; cursor: pointer; }
    button:hover { background: #45a049; }
    .note-hint { font-size: 12px; color: #666; margin-top: -8px; }
  </style>
</head>
<body>
  <h1>Beginner Band — Concert Bb Scale (Matched)</h1>

  <div class="controls">
    <label><input type="checkbox" id="concertMode" /> Show concert pitch on treble staves</label>
    <label><input type="checkbox" id="allowFlams" /> Allow Flams (q, 8)</label>
    <label><input type="checkbox" id="allowOpenRolls" checked /> Allow Open Rolls (h, w)</label>
    <label><input type="checkbox" id="allowClosedRolls" checked /> Allow Closed Rolls (h, w)</label>
    <button id="shuffleBtn" onclick="drawRandom()">Shuffle (or press Space)</button>
  </div>

  <div class="row">
    <div>
      <div class="label">Trumpet (Bb) — Written</div>
      <div id="trebleBb" class="staff"></div>
      <div class="note-hint">Display range: C4–C5</div>
    </div>
    <div>
      <div class="label">Alto Sax (Eb) — Written</div>
      <div id="trebleEb" class="staff"></div>
      <div class="note-hint">Display range: G4–G5</div>
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">Bass (Concert) — Bb Scale Only</div>
      <div id="bass" class="staff"></div>
      <div class="note-hint">Pool: Bb2 · C3 · D3 · Eb3 · F3 · G3 · A3 · Bb3</div>
    </div>
    <div>
      <div class="label">Percussion</div>
      <div id="perc" class="staff"></div>
      <div class="note-hint">No triplets · Rolls only on half/whole · Flams (if enabled) only on q/8</div>
    </div>
  </div>

  <script>
    const VF = Vex.Flow;

    // ---------- MIDI helpers ----------
    const NAT_MIDI = { c:0, d:2, e:4, f:5, g:7, a:9, b:11 };
    function midiFrom(letter, acc, oct) {
      let base = NAT_MIDI[letter];
      if (acc === "#") base += 1;
      if (acc === "b") base -= 1;
      return 12 * (oct + 1) + base;
    }
    function midiToKeyPreferClass(midi) {
      const pc = ((midi % 12) + 12) % 12;
      const oct = Math.floor(midi / 12) - 1;
      // Prefer Bb/Eb spellings for scale correctness
      const pref = {
        0:{letter:"c",acc:""}, 1:{letter:"c",acc:"#"}, 2:{letter:"d",acc:""},
        3:{letter:"e",acc:"b"}, 4:{letter:"e",acc:""}, 5:{letter:"f",acc:""},
        6:{letter:"f",acc:"#"}, 7:{letter:"g",acc:""}, 8:{letter:"g",acc:"#"},
        9:{letter:"a",acc:""}, 10:{letter:"b",acc:"b"}, 11:{letter:"b",acc:""}
      };
      const {letter,acc} = pref[pc];
      return { letter, acc, oct };
    }
    function clampByOctave(midi, lo, hi) {
      while (midi < lo) midi += 12;
      while (midi > hi) midi -= 12;
      return midi;
    }
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // ---------- Display ranges ----------
    const TRUMPET_MIN = midiFrom("c","",4); // C4
    const TRUMPET_MAX = midiFrom("c","",5); // C5
    const ALTO_MIN    = midiFrom("g","",4); // G4
    const ALTO_MAX    = midiFrom("g","",5); // G5

    // ---------- Concert Bb scale pool in bass range (Bb2..Bb3) ----------
    const CONCERT_SCALE_POOL = [
      midiFrom("b","b",2), // Bb2
      midiFrom("c","",3),  // C3
      midiFrom("d","",3),  // D3
      midiFrom("e","b",3), // Eb3
      midiFrom("f","",3),  // F3
      midiFrom("g","",3),  // G3
      midiFrom("a","",3),  // A3
      midiFrom("b","b",3)  // Bb3
    ];

    // ---------- Percussion rhythms (NO TRIPLETS) ----------
    const rhythms = [
      { label: "Whole",   duration: "w",  count: 1 },
      { label: "Half",    duration: "h",  count: 2 },
      { label: "Quarter", duration: "q",  count: 4 },
      { label: "Eighth",  duration: "8",  count: 8 },
      { label: "16th",    duration: "16", count: 16 }
    ];

    // Rolls only on half/whole; Flams (if enabled) only q/8
    const PROB_OPEN_ROLL = 0.25;
    const PROB_CLOSED_ROLL = 0.25;
    const PROB_FLAM = 0.30;

    // ---------- Draw helpers ----------
    function clearDiv(id){ const el = document.getElementById(id); if (el) el.innerHTML = ""; }
    function makeStave(divId, clef, width=640, height=160){
      const div = document.getElementById(divId);
      const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
      renderer.resize(width, height);
      const ctx = renderer.getContext();
      const stave = new VF.Stave(10, 40, width - 20);
      stave.addClef(clef).setContext(ctx).draw();
      return { ctx, stave, width, height };
    }
    function addAccidental(note, acc){
      if (acc === "#" || acc === "b") note.addAccidental(0, new VF.Accidental(acc));
    }
    function drawWholeAt(divId, clef, keyObj){
      clearDiv(divId);
      const { ctx, stave, width } = makeStave(divId, clef);
      const key = `${keyObj.letter}/${keyObj.oct}`;
      const n = new VF.StaveNote({ clef, keys:[key], duration:"w" });
      addAccidental(n, keyObj.acc);
      const v = new VF.Voice({ num_beats:4, beat_value:4 }); v.setStrict(false);
      v.addTickables([n]);
      new VF.Formatter().joinVoices([v]).format([v], width-60);
      v.draw(ctx, stave);
    }

    // ---------- Percussion (rolls only h/w; flams q/8 when enabled) ----------
    function makePercNote(duration){ return new VF.StaveNote({ clef:"percussion", keys:["b/4"], duration, stem_direction:1 }); }
    function addOpenRoll(n){ n.addModifier(0, new VF.Tremolo(2)); }
    function addClosedRoll(n){ n.addModifier(0, new VF.Tremolo(3)); }
    function addFlam(n){
      const g = new VF.GraceNote({ keys:["b/4"], duration:"8", slash:false, stem_direction:1 });
      const gg = new VF.GraceNoteGroup([g], { slur:true });
      n.addModifier(0, gg);
    }

    function drawPerc(rhythm, allowFlams, allowOpen, allowClosed){
      clearDiv("perc");
      const { ctx, stave, width } = makeStave("perc","percussion");
      let notes = [], beams=[];

      if (rhythm.duration === "w") {
        // Single whole note; apply open/closed roll if chosen
        const n = makePercNote("w");
        const r = Math.random();
        if (allowClosed && r < PROB_CLOSED_ROLL) addClosedRoll(n);
        else if (allowOpen && r < PROB_CLOSED_ROLL + PROB_OPEN_ROLL) addOpenRoll(n);
        notes = [n];
      } else {
        for (let i=0;i<rhythm.count;i++) {
          const n = makePercNote(rhythm.duration);
          // Flams only on q/8 when enabled
          if (allowFlams && (rhythm.duration === "q" || rhythm.duration === "8") && Math.random() < PROB_FLAM) {
            addFlam(n);
          }
          // Rolls only on HALF
          if (rhythm.duration === "h") {
            const r = Math.random();
            if (allowClosed && r < PROB_CLOSED_ROLL) addClosedRoll(n);
            else if (allowOpen && r < PROB_CLOSED_ROLL + PROB_OPEN_ROLL) addOpenRoll(n);
          }
          notes.push(n);
        }
        // Beams for 8ths/16ths
        if (rhythm.duration==="8" || rhythm.duration==="16") {
          beams = VF.Beam.generateBeams(notes);
        }
      }

      const v = new VF.Voice({ num_beats:4, beat_value:4 }); v.setStrict(false);
      v.addTickables(notes);
      new VF.Formatter().joinVoices([v]).format([v], width-60);
      v.draw(ctx, stave);
      beams.forEach(b=>b.setContext(ctx).draw());
    }

    // ---------- Main (concert-first, Bb scale only) ----------
    function drawRandom(){
      const concertMode = document.getElementById("concertMode").checked;
      const allowFlams = document.getElementById("allowFlams").checked;
      const allowOpen   = document.getElementById("allowOpenRolls").checked;
      const allowClosed = document.getElementById("allowClosedRolls").checked;

      // 1) Pick one concert pitch ONLY from the Bb scale pool (Bb2..Bb3)
      const concertMidi = CONCERT_SCALE_POOL[randInt(0, CONCERT_SCALE_POOL.length-1)];

      // 2) Build treble displays
      let tMidiWritten = concertMidi + 2;  // Bb treble written = concert + M2
      let aMidiWritten = concertMidi + 9;  // Eb treble written = concert + M6

      // Clamp written to display windows (keeps pitch class, adjusts octave)
      tMidiWritten = clampByOctave(tMidiWritten, TRUMPET_MIN, TRUMPET_MAX);
      aMidiWritten = clampByOctave(aMidiWritten, ALTO_MIN, ALTO_MAX);

      // If concertMode is ON, show concert note on treble staves too (octave-clamped)
      const tMidiDisplay = concertMode ? clampByOctave(concertMidi, TRUMPET_MIN, TRUMPET_MAX) : tMidiWritten;
      const aMidiDisplay = concertMode ? clampByOctave(concertMidi, ALTO_MIN, ALTO_MAX)     : aMidiWritten;

      const tKey = midiToKeyPreferClass(tMidiDisplay);
      const aKey = midiToKeyPreferClass(aMidiDisplay);
      const bKey = midiToKeyPreferClass(concertMidi); // bass shows the exact concert note (Bb scale)

      // 3) Draw winds
      drawWholeAt("trebleBb","treble", tKey);
      drawWholeAt("trebleEb","treble", aKey);
      drawWholeAt("bass","bass", bKey);

      // 4) Percussion rhythm & ornaments
      const rhythm = rhythms[randInt(0, rhythms.length-1)];
      drawPerc(rhythm, allowFlams, allowOpen, allowClosed);
    }

    // Init + controls
    drawRandom();
    document.addEventListener("keydown", (ev)=>{ if (ev.code==="Space"){ev.preventDefault(); drawRandom();} });
    document.getElementById("shuffleBtn").addEventListener("click", drawRandom);
    document.getElementById("concertMode").addEventListener("change", drawRandom);
    document.getElementById("allowFlams").addEventListener("change", drawRandom);
    document.getElementById("allowOpenRolls").addEventListener("change", drawRandom);
    document.getElementById("allowClosedRolls").addEventListener("change", drawRandom);
  </script>
</body>
</html>
