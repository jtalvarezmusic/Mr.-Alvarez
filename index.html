<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Band Note & Rhythm Randomizer — Bb Trumpet + Eb Alto + Concert Bass</title>
  <!-- VexFlow v3 UMD so window.Vex and Vex.Flow exist -->
  <script src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    h1 { margin-top: 20px; }
    .controls { display: flex; gap: 16px; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .controls label { user-select: none; }
    .row { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; margin-top: 16px; }
    .label { font-weight: 600; margin: 6px 0 0; }
    .staff { width: 640px; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.2); padding: 10px; }
    .staff.wide { width: 920px; }
    button { margin: 16px 6px 24px; padding: 10px 20px; font-size: 18px; border: none; border-radius: 10px; background: #4caf50; color: #fff; cursor: pointer; }
    button:hover { background: #45a049; }
    .note-hint { font-size: 12px; color: #666; margin-top: -8px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <h1>Band Note & Rhythm Randomizer</h1>

  <div class="controls">
    <label><input type="checkbox" id="allowFlams" checked /> Allow Flams (q, 8)</label>
    <label><input type="checkbox" id="allowOpenRolls" checked /> Allow Open Rolls (q, h)</label>
    <label><input type="checkbox" id="allowClosedRolls" checked /> Allow Closed Rolls (h, w)</label>
    <label><input type="checkbox" id="percOnly" /> Percussion only</label>
    <button id="shuffleBtn" onclick="drawRandom()">Shuffle (or press Space)</button>
  </div>

  <div class="row" id="windsRow1">
    <div>
      <div class="label">Treble — Trumpet/Clarinet (Bb)</div>
      <div id="trebleBb" class="staff"></div>
    </div>
    <div>
      <div class="label">Treble — Alto Sax (Eb)</div>
      <div id="trebleEb" class="staff"></div>
    </div>
  </div>

  <div class="row" id="windsRow2">
    <div>
      <div class="label">Bass — Concert Pitch</div>
      <div id="bass" class="staff"></div>
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">Percussion</div>
      <div id="perc" class="staff"></div>
      <div class="note-hint">Flams: q/8 · Open rolls: q/h · Closed rolls: h/w · Triplet 8ths are plain</div>
    </div>
  </div>

  <script>
    const VF = Vex.Flow; // v3 API

    // ---------- Utilities ----------
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function chance(p) { return Math.random() < p; }
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));

    // Accidentals allowed (naturals + C#, F#, G#, Bb, Eb, Db)
    const allowedAccidentals = {
      g: ["", "#"], a: [""], b: ["", "b"], c: ["", "#"], d: ["", "b"], e: ["", "b"], f: ["", "#"]
    };

    // MIDI helpers
    const NAT_MIDI = { c:0, d:2, e:4, f:5, g:7, a:9, b:11 };
    function midiFrom(letter, acc, oct) {
      let base = NAT_MIDI[letter];
      if (acc === "#") base += 1;
      if (acc === "b") base -= 1;
      return 12 * (oct + 1) + base;
    }
    // Prefer common spellings from your allowed set
    function midiToKeyPreferClass(midi) {
      const pc = ((midi % 12) + 12) % 12;
      const oct = Math.floor(midi / 12) - 1;
      const pref = {
        0:{letter:"c",acc:""}, 1:{letter:"c",acc:"#"}, 2:{letter:"d",acc:""},
        3:{letter:"e",acc:"b"}, 4:{letter:"e",acc:""}, 5:{letter:"f",acc:""},
        6:{letter:"f",acc:"#"}, 7:{letter:"g",acc:""}, 8:{letter:"g",acc:"#"},
        9:{letter:"a",acc:""}, 10:{letter:"b",acc:"b"}, 11:{letter:"b",acc:""}
      };
      const {letter,acc} = pref[pc];
      return { letter, acc, oct };
    }

    // Ranges (MIDI)
    const TREBLE_MIN = 55; // G3
    const TREBLE_MAX = 79; // G5
    const BASS_MIN   = 45; // A2
    const BASS_MAX   = 60; // C4

    function clampToRangeByOctave(midi, lo, hi) {
      while (midi < lo) midi += 12;
      while (midi > hi) midi -= 12;
      return midi;
    }

    // Pick a CONCERT pitch first, centered for winds & bass display
    function pickConcertMidi() {
      // Build a small concert pool in comfortable band range (C3..C5),
      // then we’ll clamp bass to A2..C4 and written treble to G3..G5.
      const pool = [];
      for (let oct = 3; oct <= 5; oct++) {
        for (const letter of ["c","d","e","f","g","a","b"]) {
          for (const acc of allowedAccidentals[letter]) {
            pool.push(midiFrom(letter, acc, oct));
          }
        }
      }
      return pool[randInt(0, pool.length - 1)];
    }

    // ---------- Percussion config ----------
    const rhythms = [
      { label: "Whole",   duration: "w",  count: 1 },
      { label: "Half",    duration: "h",  count: 2 },
      { label: "Quarter", duration: "q",  count: 4 },
      { label: "Eighth",  duration: "8",  count: 8 },
      { label: "16th",    duration: "16", count: 16 },
      { label: "Triplet 8ths", duration: "8", count: 12, triplet: true } // plain by rule
    ];
    const PROB_FLAM = 0.30;        // quarters, eighths
    const PROB_OPEN_ROLL = 0.25;   // quarters, halves
    const PROB_CLOSED_ROLL = 0.25; // halves, wholes

    // ---------- Drawing helpers ----------
    function clearDiv(id) { const el = document.getElementById(id); if (el) el.innerHTML = ""; }
    function makeStave(divId, clef, width = 620, height = 160) {
      const div = document.getElementById(divId);
      const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
      renderer.resize(width, height);
      const context = renderer.getContext();
      const stave = new VF.Stave(10, 40, width - 20);
      stave.addClef(clef).setContext(context).draw();
      return { renderer, context, stave, width, height };
    }
    function addAccidentalIfNeeded(note, acc) {
      if (acc === "#" || acc === "b") note.addAccidental(0, new VF.Accidental(acc));
    }
    function drawSingleWholeKey(divId, clef, letter, acc, oct, width) {
      clearDiv(divId);
      const { context, stave } = makeStave(divId, clef, width);
      const key = `${letter}/${oct}`;
      const note = new VF.StaveNote({ clef, keys: [key], duration: "w" });
      addAccidentalIfNeeded(note, acc);
      const voice = new VF.Voice({ num_beats: 4, beat_value: 4 }); voice.setStrict(false);
      voice.addTickables([note]);
      new VF.Formatter().joinVoices([voice]).format([voice], width - 60);
      voice.draw(context, stave);
    }

    // ---------- Percussion helpers ----------
    function makePercNote(duration) { return new VF.StaveNote({ clef: "percussion", keys: ["b/4"], duration, stem_direction: 1 }); }
    function addFlam(note) {
      const g = new VF.GraceNote({ keys: ["b/4"], duration: "8", slash: false, stem_direction: 1 });
      const gg = new VF.GraceNoteGroup([g], { slur: true });
      note.addModifier(0, gg);
    }
    function addOpenRoll(note) { note.addModifier(0, new VF.Tremolo(2)); }   // 2 slashes
    function addClosedRoll(note) { note.addModifier(0, new VF.Tremolo(3)); } // 3 slashes
    function applyRudimentsToNotes(notes, rhythm, allowFlams, allowOpenRolls, allowClosedRolls) {
      for (const n of notes) {
        if (rhythm.triplet) continue; // keep triplets plain
        const dur = rhythm.duration;
        if (allowFlams && (dur === "q" || dur === "8") && chance(PROB_FLAM)) { addFlam(n); continue; }
        if (allowOpenRolls && (dur === "q" || dur === "h") && chance(PROB_OPEN_ROLL)) { addOpenRoll(n); continue; }
        if (allowClosedRolls && dur === "h" && chance(PROB_CLOSED_ROLL)) { addClosedRoll(n); continue; }
      }
    }
    function drawPercussion(rhythm, allowFlams, allowOpenRolls, allowClosedRolls, width) {
      clearDiv("perc");
      const { context, stave } = makeStave("perc", "percussion", width);
      let notes = [], beams = [], tuplets = [], tie = null;
      if (rhythm.duration === "w") {
        const n1 = makePercNote("h"), n2 = makePercNote("h");
        if (allowClosedRolls && chance(PROB_CLOSED_ROLL)) { addClosedRoll(n1); addClosedRoll(n2); }
        notes = [n1, n2];
        tie = new VF.StaveTie({ first_note: n1, last_note: n2, first_indices: [0], last_indices: [0] });
      } else {
        for (let i = 0; i < rhythm.count; i++) notes.push(makePercNote(rhythm.duration));
        if (rhythm.triplet) {
          for (let i = 0; i < notes.length; i += 3) {
            const group = notes.slice(i, i + 3);
            if (group.length === 3) tuplets.push(new VF.Tuplet(group, { num_notes: 3, notes_occupied: 2 }));
          }
        }
        if (rhythm.duration === "8" || rhythm.duration === "16") {
          beams = VF.Beam.generateBeams(notes);
        }
        applyRudimentsToNotes(notes, rhythm, allowFlams, allowOpenRolls, allowClosedRolls);
      }
      const voice = new VF.Voice({ num_beats: 4, beat_value: 4 }); voice.setStrict(false);
      voice.addTickables(notes);
      new VF.Formatter().joinVoices([voice]).format([voice], width - 60);
      voice.draw(context, stave);
      beams.forEach(b => b.setContext(context).draw());
      tuplets.forEach(t => t.setContext(context).draw());
      if (tie) tie.setContext(context).draw();
    }

    // ---------- Main randomizer ----------
    function drawRandom() {
      const percOnly = document.getElementById("percOnly").checked;

      // Toggle winds visibility & percussion width
      const windsRow1 = document.getElementById("windsRow1");
      const windsRow2 = document.getElementById("windsRow2");
      windsRow1.classList.toggle("hidden", percOnly);
      windsRow2.classList.toggle("hidden", percOnly);
      document.getElementById("perc").classList.toggle("wide", percOnly);

      const windWidth = 620;
      const percWidth = percOnly ? 920 : 660;

      // ---- Choose a single CONCERT pitch ----
      const concertMidiRaw = pickConcertMidi();
      const concertMidiBass = clampToRangeByOctave(concertMidiRaw, BASS_MIN, BASS_MAX);
      const concertBassKey = midiToKeyPreferClass(concertMidiBass);

      // Written for Bb treble = concert + 2 semitones (then clamp to G3..G5)
      let writtenBb = concertMidiRaw + 2;
      writtenBb = clampToRangeByOctave(writtenBb, TREBLE_MIN, TREBLE_MAX);
      const trebleBbKey = midiToKeyPreferClass(writtenBb);

      // Written for Eb treble = concert + 9 semitones (M6) (then clamp to G3..G5)
      let writtenEb = concertMidiRaw + 9;
      writtenEb = clampToRangeByOctave(writtenEb, TREBLE_MIN, TREBLE_MAX);
      const trebleEbKey = midiToKeyPreferClass(writtenEb);

      if (!percOnly) {
        // Draw two treble staves and one bass (concert)
        drawSingleWholeKey("trebleBb", "treble", trebleBbKey.letter, trebleBbKey.acc, trebleBbKey.oct, windWidth);
        drawSingleWholeKey("trebleEb", "treble", trebleEbKey.letter, trebleEbKey.acc, trebleEbKey.oct, windWidth);
        drawSingleWholeKey("bass", "bass", concertBassKey.letter, concertBassKey.acc, concertBassKey.oct, windWidth);
      } else {
        clearDiv("trebleBb"); clearDiv("trebleEb"); clearDiv("bass");
      }

      // Rudiment toggles
      const allowFlams = document.getElementById("allowFlams").checked;
      const allowOpenRolls = document.getElementById("allowOpenRolls").checked;
      const allowClosedRolls = document.getElementById("allowClosedRolls").checked;

      // Percussion
      const rhythm = rhythms[randInt(0, rhythms.length - 1)];
      drawPercussion(rhythm, allowFlams, allowOpenRolls, allowClosedRolls, percWidth);
    }

    // Init + controls
    drawRandom();
    document.addEventListener("keydown", (ev) => { if (ev.code === "Space") { ev.preventDefault(); drawRandom(); } });
    document.getElementById("shuffleBtn").addEventListener("click", drawRandom);
    ["percOnly","allowFlams","allowOpenRolls","allowClosedRolls"].forEach(id => {
      document.getElementById(id).addEventListener("change", drawRandom);
    });
  </script>
</body>
</html>
